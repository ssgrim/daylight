"use strict";var J=Object.create;var g=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var ee=(e,t)=>{for(var r in t)g(e,r,{get:t[r],enumerable:!0})},k=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of z(t))!Z.call(e,o)&&o!==r&&g(e,o,{get:()=>t[o],enumerable:!(n=q(t,o))||n.enumerable});return e};var y=(e,t,r)=>(r=e!=null?J(Q(e)):{},k(t||!e||!e.__esModule?g(r,"default",{value:e,enumerable:!0}):r,e)),te=e=>k(g({},"__esModule",{value:!0}),e);var me={};ee(me,{handler:()=>le});module.exports=te(me);var K=y(require("fs"),1),H=y(require("path"),1);function P(e=100){let t=new Map;return{get(r){if(!t.has(r))return;let n=t.get(r);return t.delete(r),t.set(r,n),n},set(r,n){for(t.has(r)&&t.delete(r),t.set(r,n);t.size>e;)t.delete(t.keys().next().value)}}}function re(e){return[12,1,2].includes(e)?"winter":[3,4,5].includes(e)?"spring":[6,7,8].includes(e)?"summer":"autumn"}function ne(e){let t=e.getUTCMonth()+1,r=e.getUTCDate(),n=t*100+r;return n>=1221||n<320?"winter":n>=320&&n<621?"spring":n>=621&&n<922?"summer":"autumn"}function F(e,t=new Date,r){let n=process&&process.env&&process.env.SEASON_MODE||r||"meteorological",o=t.getUTCMonth()+1,c=n==="astronomical"?ne(t):re(o),a=e<0?"south":"north";return{season:e<0?c==="winter"?"summer":c==="summer"?"winter":c==="spring"?"autumn":"spring":c,hemisphere:a,mode:n}}var O=y(require("sqlite3"),1),U=require("sqlite"),M=y(require("path"),1),v=y(require("fs"),1),A=M.default.resolve(process.cwd(),"backend","external_history.sqlite");async function V(){try{let e=M.default.dirname(A);v.default.existsSync(e)||v.default.mkdirSync(e,{recursive:!0});try{v.default.openSync(A,"a").close()}catch{}let t=await(0,U.open)({filename:A,driver:O.default.Database});return await t.exec("CREATE TABLE IF NOT EXISTS history (id INTEGER PRIMARY KEY, ts TEXT, type TEXT, provider TEXT, lat REAL, lng REAL, ok INTEGER, error TEXT)"),t}catch(e){throw console.warn("initDb failed",String(e)),e}}async function E(e,t){await e.run("INSERT INTO history (ts,type,provider,lat,lng,ok,error) VALUES (?,?,?,?,?,?,?)",t.ts,t.type,t.provider,t.lat,t.lng,t.ok?1:0,t.error||null)}var T=require("@aws-sdk/client-secrets-manager"),I=require("@aws-sdk/client-ssm"),oe=new T.SecretsManagerClient({}),ae=new I.SSMClient({}),R=new Map;async function h(e,t={fromSSM:!1}){if(!e)return null;if(R.has(e))return R.get(e);try{if(t.fromSSM){let c=new I.GetParameterCommand({Name:e,WithDecryption:!0}),i=(await ae.send(c)).Parameter?.Value||null;return R.set(e,i),i}let r=new T.GetSecretValueCommand({SecretId:e}),o=(await oe.send(r)).SecretString||null;return R.set(e,o),o}catch(r){return console.warn("getSecretValue error",String(r)),null}}function C(e,t={},r=3e3){let n=new AbortController,o=setTimeout(()=>n.abort(),r);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(o))}async function _(e,t=2,r=300){let n=null;for(let o=0;o<t;o++)try{return await e()}catch(c){n=c,await new Promise(a=>setTimeout(a,r))}throw n}var x=null;async function se(){if(x===null)try{x=(await import("ioredis")).default}catch{x=!1}return x}async function G(){let e=process.env.REDIS_URL,t=await se();if(!e||!t)return null;let r=new t(e);return{async get(n){try{let o=await r.get(n);return o?JSON.parse(o):void 0}catch{return}},async set(n,o,c=6e4){try{await r.set(n,JSON.stringify(o),"PX",c)}catch{}},async clear(){try{await r.flushdb()}catch{}}}}async function b(e=6e4){try{let r=await G();if(r)return{async get(n){return await r.get(n)},async set(n,o){return await r.set(n,o,e)},async clear(){return await r.clear()}}}catch{}let t=new Map;return{get(r){let n=t.get(r);if(n){if(Date.now()>n.expiry){t.delete(r);return}return n.value}},set(r,n){t.set(r,{value:n,expiry:Date.now()+e})},clear(){t.clear()}}}var ce=b(3e4);async function L(e,t){let r=await ce,n=process.env.EVENTS_PROVIDER||"mock";if(n==="ticketmaster"){let o=`events:${e},${t}:tm`,c=await r.get(o);if(c)return c;let a=process.env.EVENTS_API_KEY,i=process.env.EVENTS_SSM_PARAMETER;i&&(a=await h(i,{fromSSM:!0})||a);let s=process.env.EVENTS_SECRET_ARN;if(!a&&s&&(a=await h(s)||a),!a)throw new Error("EVENTS_API_KEY not set");let l=`https://app.ticketmaster.com/discovery/v2/events.json?latlong=${encodeURIComponent(e)},${encodeURIComponent(t)}&radius=10&apikey=${encodeURIComponent(a)}`,u=await _(()=>C(l,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`events fetch failed: ${u.status}`);let d=((await u.json())._embedded?.events||[]).slice(0,3).map(w=>({id:w.id,name:w.name,venue:w._embedded?.venues?.[0]?.name,date:w.dates?.start?.dateTime,image:(w.images||[])[0]?.url||null,url:w.url||null,genre:w.classifications?.[0]?.genre?.name||null})),f={provider:n,events:d};return await r.set(o,f),f}return{provider:"mock",events:[{name:"Farmers Market",venue:"Main St Park",date:null},{name:"Open-Air Concert",venue:"River Stage",date:null}]}}var ie=b(2e4);async function j(e,t){let r=await ie,n=process.env.TRAFFIC_PROVIDER||"mock";if(n==="here"){let o=`traffic:${e},${t}:here`,c=await r.get(o);if(c)return c;let a=process.env.HERE_API_KEY,i=process.env.TRAFFIC_SSM_PARAMETER;i&&(a=await h(i,{fromSSM:!0})||a);let s=process.env.TRAFFIC_SECRET_ARN;if(!a&&s&&(a=await h(s)||a),!a)throw new Error("HERE_API_KEY not set");let l=`https://traffic.ls.hereapi.com/traffic/6.2/flow.json?prox=${encodeURIComponent(e)},${encodeURIComponent(t)},5000&apiKey=${encodeURIComponent(a)}`,u=await _(()=>C(l,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`traffic fetch failed: ${u.status}`);let p=await u.json(),d=p.RWS?.[0]?.RW?.[0]?.FIS?.[0]?.FI?.[0]?.CF?.[0]?.JF?Math.min(100,Math.round(p.RWS[0].RW[0].FIS[0].FI[0].CF[0].JF*10)):20,f={provider:n,congestion:d};return await r.set(o,f),f}return{provider:"mock",congestion:Math.round(Math.random()*40+10)}}var D=P(500),ue=H.default.resolve(process.cwd(),"backend","external_history.log"),m=null;try{m=V()}catch{m=null}function N(e,t={},r=3e3){let n=new AbortController,o=setTimeout(()=>n.abort(),r);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(o))}async function $(e,t=2,r=300){let n=null;for(let o=0;o<t;o++)try{return await e()}catch(c){n=c,await new Promise(a=>setTimeout(a,r))}throw n}function S(e){try{K.default.appendFileSync(ue,JSON.stringify({ts:new Date().toISOString(),...e})+`
`)}catch{}}async function X(e,t){let r=process.env.WEATHER_PROVIDER||"open-meteo";if(r==="open-meteo"){let n=`https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(e)}&longitude=${encodeURIComponent(t)}&current_weather=true&timezone=UTC`,o=await $(()=>N(n,{method:"GET"},2500),2,300);if(!o.ok)throw new Error(`weather fetch failed: ${o.status}`);let a=(await o.json()).current_weather||{},i=a.temperature!=null?`Temp ${a.temperature}\xB0C, wind ${a.windspeed} km/h`:void 0,s=F(e,new Date);return S({type:"weather",provider:r,lat:e,lng:t,ok:!0,season:s}),{temperatureC:a.temperature,windSpeedKph:a.windspeed,weatherCode:a.weathercode,summary:i,season:s}}throw new Error("unsupported weather provider")}async function W(e,t){try{return await L(e,t)}catch(r){return{provider:"error",events:[],error:String(r)}}}async function Y(e,t){try{return await j(e,t)}catch(r){return{provider:"error",congestion:null,error:String(r)}}}async function B(e,t){let r=`${e},${t}`,n=D.get(r);if(n)return n;let o=process.env.GEOCODE_PROVIDER||"nominatim";if(o==="nominatim"){let c=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(e)}&lon=${encodeURIComponent(t)}`;try{let a=await $(()=>N(c,{method:"GET",headers:{"User-Agent":"daylight/0.1 (+https://example.com)"}},2500),2,300);if(!a.ok)throw new Error(`geocode fetch failed: ${a.status}`);let s={display_name:(await a.json()).display_name};D.set(r,s);let l={type:"geocode",provider:o,lat:e,lng:t,ok:!0};return m?(await m).then(u=>E(u,{ts:new Date().toISOString(),...l})):S(l),s}catch(a){let i={type:"geocode",provider:o,lat:e,lng:t,ok:!1,error:String(a)};throw m?(await m).then(s=>E(s,{ts:new Date().toISOString(),...i})):S(i),a}}if(o==="mapbox"){let c=process.env.MAPBOX_TOKEN,a=process.env.MAPBOX_SECRET_ARN;if(a)try{let s=await h(a);s&&(c=s)}catch{}if(!c)throw new Error("MAPBOX_TOKEN not set");let i=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)},${encodeURIComponent(e)}.json?access_token=${encodeURIComponent(c)}&limit=1`;try{let s=await $(()=>N(i,{method:"GET"},2500),2,300);if(!s.ok)throw new Error(`mapbox geocode failed: ${s.status}`);let p={display_name:(await s.json()).features?.[0]?.place_name};D.set(r,p);let d={type:"geocode",provider:o,lat:e,lng:t,ok:!0};return m?(await m).then(f=>E(f,{ts:new Date().toISOString(),...d})):S(d),p}catch(s){let l={type:"geocode",provider:o,lat:e,lng:t,ok:!1,error:String(s)};throw m?(await m).then(u=>E(u,{ts:new Date().toISOString(),...l})):S(l),s}}throw new Error("unsupported geocode provider")}var le=async e=>{let t=new Date().toISOString();try{let r=e.queryStringParameters||{},n=r.lat?Number(r.lat):NaN,o=r.lng?Number(r.lng):NaN,c,a=null,i=null,s=null;if(!Number.isNaN(n)&&!Number.isNaN(o)){let[u,p,d,f]=await Promise.all([X(n,o),B(n,o),W(n,o),Y(n,o)]);c=[p.display_name,u.summary].filter(Boolean).join(" \u2014 "),a=u&&u.season||null,i=d,s=f}let l=95;return a?.season==="summer"&&(l+=3),a?.season==="winter"&&(l-=5),s?.congestion!=null&&s.congestion>70&&(l-=10),{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Live Stop",start:t,end:t,score:l,reason:c,season:a,events:i,traffic:s}])}}catch(r){return{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Demo Stop",start:t,end:t,score:95,reason:`enrich failed: ${r.message}`}])}}};0&&(module.exports={handler});
