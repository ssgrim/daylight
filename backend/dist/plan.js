import fe from"fs";import de from"path";var F=null;try{F=(await import("ioredis")).default}catch{}function N(){let e=process.env.REDIS_URL;if(!e||!F)return null;let t=new F(e);return{async get(a){try{let n=await t.get(a);return n?JSON.parse(n):void 0}catch{return}},async set(a,n,o=6e4){try{await t.set(a,JSON.stringify(n),"PX",o)}catch{}},async clear(){try{await t.flushdb()}catch{}}}}function h(e=6e4){let t=0,a=0,n=0,o=0,r=new Set;try{let i=N();if(i)return{async get(s){if(r.has(s)){a++;return}let u=await i.get(s);if(u!==void 0)return t++,u;a++},async set(s,u,f=e){return n++,r.delete(s),await i.set(s,u,f)},async clear(){return o++,r.clear(),await i.clear()},invalidate(s){o++,r.add(s)},metrics(){return{hits:t,misses:a,sets:n,invalidations:o}}}}catch{}let c=new Map;return{get(i){if(r.has(i)){a++;return}let s=c.get(i);if(!s){a++;return}if(Date.now()>s.expiry){c.delete(i),a++;return}return t++,s.value},set(i,s,u=e){n++,r.delete(i),c.set(i,{value:s,expiry:Date.now()+u})},clear(){o++,r.clear(),c.clear()},invalidate(i){o++,r.add(i)},metrics(){return{hits:t,misses:a,sets:n,invalidations:o}}}}function ee(e){return[12,1,2].includes(e)?"winter":[3,4,5].includes(e)?"spring":[6,7,8].includes(e)?"summer":"autumn"}function te(e){let t=e.getUTCMonth()+1,a=e.getUTCDate(),n=t*100+a;return n>=1221||n<320?"winter":n>=320&&n<621?"spring":n>=621&&n<922?"summer":"autumn"}function k(e,t=new Date,a){let n=process&&process.env&&process.env.SEASON_MODE||a||"meteorological",o=t.getUTCMonth()+1,r=n==="astronomical"?te(t):ee(o),c=e<0?"south":"north";return{season:e<0?r==="winter"?"summer":r==="summer"?"winter":r==="spring"?"autumn":"spring":r,hemisphere:c,mode:n}}import re from"sqlite3";import{open as ne}from"sqlite";import L from"path";import A from"fs";function M(e,t){let a={},n=t;return t.length&&typeof t[0]=="object"&&t[0]&&t[0].requestId&&(a=t[0],n=t.slice(1)),JSON.stringify({level:e,time:new Date().toISOString(),...a,msg:n.map(String).join(" ")})}function S(...e){console.log(M("info",e))}function g(...e){console.warn(M("warn",e))}function V(...e){console.error(M("error",e))}var P=L.resolve(process.cwd(),"backend","external_history.sqlite");async function U(){try{let e=L.dirname(P);A.existsSync(e)||A.mkdirSync(e,{recursive:!0});try{A.openSync(P,"a").close()}catch{}let t=await ne({filename:P,driver:re.Database});return await t.exec("CREATE TABLE IF NOT EXISTS history (id INTEGER PRIMARY KEY, ts TEXT, type TEXT, provider TEXT, lat REAL, lng REAL, ok INTEGER, error TEXT)"),t}catch(e){throw g("initDb failed",String(e)),e}}async function v(e,t){await e.run("INSERT INTO history (ts,type,provider,lat,lng,ok,error) VALUES (?,?,?,?,?,?,?)",t.ts,t.type,t.provider,t.lat,t.lng,t.ok?1:0,t.error||null)}import{SecretsManagerClient as oe,GetSecretValueCommand as ae}from"@aws-sdk/client-secrets-manager";import{SSMClient as ie,GetParameterCommand as ce}from"@aws-sdk/client-ssm";var se=new oe({}),ue=new ie({}),T=new Map;async function w(e,t={fromSSM:!1}){if(!e)return null;if(T.has(e))return T.get(e);try{if(t.fromSSM){let r=new ce({Name:e,WithDecryption:!0}),i=(await ue.send(r)).Parameter?.Value||null;return T.set(e,i),i}let a=new ae({SecretId:e}),o=(await se.send(a)).SecretString||null;return T.set(e,o),o}catch(a){return g("getSecretValue error",String(a)),null}}function R(e,t={},a=3e3){let n=new AbortController,o=setTimeout(()=>n.abort(),a);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(o))}async function C(e,t=2,a=300){let n=null;for(let o=0;o<t;o++)try{return await e()}catch(r){n=r,await new Promise(c=>setTimeout(c,a))}throw n}var j=h(3e4);async function G(e,t){let a=process.env.EVENTS_PROVIDER||"mock";if(a==="ticketmaster"){let n=`events:${e},${t}:tm`,o=await j.get(n);if(o)return o;let r=process.env.EVENTS_API_KEY,c=process.env.EVENTS_SSM_PARAMETER;c&&(r=await w(c,{fromSSM:!0})||r);let i=process.env.EVENTS_SECRET_ARN;if(!r&&i&&(r=await w(i)||r),!r)throw new Error("EVENTS_API_KEY not set");let s=`https://app.ticketmaster.com/discovery/v2/events.json?latlong=${encodeURIComponent(e)},${encodeURIComponent(t)}&radius=10&apikey=${encodeURIComponent(r)}`,u=await C(()=>R(s,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`events fetch failed: ${u.status}`);let d=((await u.json())._embedded?.events||[]).slice(0,3).map(m=>({id:m.id,name:m.name,venue:m._embedded?.venues?.[0]?.name,date:m.dates?.start?.dateTime,image:(m.images||[])[0]?.url||null,url:m.url||null,genre:m.classifications?.[0]?.genre?.name||null})),l={provider:a,events:d};return await j.set(n,l,3e4),l}return{provider:"mock",events:[{name:"Farmers Market",venue:"Main St Park",date:null},{name:"Open-Air Concert",venue:"River Stage",date:null}]}}var q=h(2e4);async function K(e,t){let a=process.env.TRAFFIC_PROVIDER||"mock";if(a==="here"){let n=`traffic:${e},${t}:here`,o=await q.get(n);if(o)return o;let r=process.env.HERE_API_KEY,c=process.env.TRAFFIC_SSM_PARAMETER;c&&(r=await w(c,{fromSSM:!0})||r);let i=process.env.TRAFFIC_SECRET_ARN;if(!r&&i&&(r=await w(i)||r),!r)throw new Error("HERE_API_KEY not set");let s=`https://traffic.ls.hereapi.com/traffic/6.2/flow.json?prox=${encodeURIComponent(e)},${encodeURIComponent(t)},5000&apiKey=${encodeURIComponent(r)}`,u=await C(()=>R(s,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`traffic fetch failed: ${u.status}`);let f=await u.json(),d=f.RWS?.[0]?.RW?.[0]?.FIS?.[0]?.FI?.[0]?.CF?.[0]?.JF?Math.min(100,Math.round(f.RWS[0].RW[0].FIS[0].FI[0].CF[0].JF*10)):20,l={provider:a,congestion:d};return await q.set(n,l,2e4),l}return{provider:"mock",congestion:Math.round(Math.random()*40+10)}}var $=parseInt(process.env.GEOCODE_TTL_MS||String(24*60*60*1e3)),H=parseInt(process.env.WEATHER_TTL_MS||String(2*60*1e3)),W=parseInt(process.env.EVENTS_TTL_MS||String(60*1e3)),X=parseInt(process.env.TRAFFIC_TTL_MS||String(30*1e3)),y=h($),I=h(H),_=h(W),x=h(X);var le=de.resolve(process.cwd(),"backend","external_history.log"),p=null;try{p=U()}catch{p=null}function O(e,t={},a=3e3){let n=new AbortController,o=setTimeout(()=>n.abort(),a);return fetch(e,{...t,signal:n.signal}).finally(()=>clearTimeout(o))}async function D(e,t=2,a=300){let n=null;for(let o=0;o<t;o++)try{return await e()}catch(r){n=r,await new Promise(c=>setTimeout(c,a))}throw n}function E(e){try{fe.appendFileSync(le,JSON.stringify({ts:new Date().toISOString(),...e})+`
`)}catch{}}var pe={"open-meteo":async(e,t)=>{let a=`https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(e)}&longitude=${encodeURIComponent(t)}&current_weather=true&timezone=UTC`,n=await D(()=>O(a,{method:"GET"},2500),2,300);if(!n.ok)throw new Error(`weather fetch failed: ${n.status}`);let r=(await n.json()).current_weather||{},c=r.temperature!=null?`Temp ${r.temperature}\xB0C, wind ${r.windspeed} km/h`:void 0,i=k(e,new Date);return E({type:"weather",provider:"open-meteo",lat:e,lng:t,ok:!0,season:i}),{temperatureC:r.temperature,windSpeedKph:r.windspeed,weatherCode:r.weathercode,summary:c,season:i}}},me={default:async(e,t)=>G(e,t)},he={default:async(e,t)=>K(e,t)};async function J(e,t){let a=process.env.WEATHER_PROVIDER||"open-meteo",n=pe[a];if(!n)throw new Error("unsupported weather provider: "+a);let o=`weather:${a}:${e.toFixed(5)}:${t.toFixed(5)}`;try{let c=I?await I.get(o):void 0;if(c)return c}catch{}let r=await n(e,t);try{I&&await I.set(o,r,H)}catch{}return r}async function Y(e,t){let a=process.env.EVENTS_PROVIDER||"default",n=me[a];if(!n)throw new Error("unsupported events provider: "+a);try{let o=`events:${a}:${e.toFixed(4)}:${t.toFixed(4)}`;try{let c=_?await _.get(o):void 0;if(c)return c}catch{}let r=await n(e,t);try{_&&await _.set(o,r,W)}catch{}return r}catch(o){return{provider:"error",events:[],error:String(o)}}}async function B(e,t){let a=process.env.TRAFFIC_PROVIDER||"default",n=he[a];if(!n)throw new Error("unsupported traffic provider: "+a);try{let o=`traffic:${a}:${e.toFixed(4)}:${t.toFixed(4)}`;try{let c=x?await x.get(o):void 0;if(c)return c}catch{}let r=await n(e,t);try{x&&await x.set(o,r,X)}catch{}return r}catch(o){return{provider:"error",congestion:null,error:String(o)}}}async function z(e,t){let a=`${e.toFixed(6)},${t.toFixed(6)}`;try{let o=y?await y.get(a):void 0;if(o)return o}catch{}let n=process.env.GEOCODE_PROVIDER||"nominatim";if(n==="nominatim"){let o=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(e)}&lon=${encodeURIComponent(t)}`;try{let r=await D(()=>O(o,{method:"GET",headers:{"User-Agent":"daylight/0.1 (+https://example.com)"}},2500),2,300);if(!r.ok)throw new Error(`geocode fetch failed: ${r.status}`);let i={display_name:(await r.json()).display_name};try{y&&await y.set(a,i,$)}catch{}let s={type:"geocode",provider:n,lat:e,lng:t,ok:!0};return p?(await p).then(u=>v(u,{ts:new Date().toISOString(),...s})):E(s),i}catch(r){let c={type:"geocode",provider:n,lat:e,lng:t,ok:!1,error:String(r)};throw p?(await p).then(i=>v(i,{ts:new Date().toISOString(),...c})):E(c),r}}if(n==="mapbox"){let o=process.env.MAPBOX_TOKEN,r=process.env.MAPBOX_SECRET_ARN;if(r)try{let i=await w(r);i&&(o=i)}catch{}if(!o)throw new Error("MAPBOX_TOKEN not set");let c=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)},${encodeURIComponent(e)}.json?access_token=${encodeURIComponent(o)}&limit=1`;try{let i=await D(()=>O(c,{method:"GET"},2500),2,300);if(!i.ok)throw new Error(`mapbox geocode failed: ${i.status}`);let f={display_name:(await i.json()).features?.[0]?.place_name};try{y&&await y.set(a,f,$)}catch{}let d={type:"geocode",provider:n,lat:e,lng:t,ok:!0};return p?(await p).then(l=>v(l,{ts:new Date().toISOString(),...d})):E(d),f}catch(i){let s={type:"geocode",provider:n,lat:e,lng:t,ok:!1,error:String(i)};throw p?(await p).then(u=>v(u,{ts:new Date().toISOString(),...s})):E(s),i}}throw new Error("unsupported geocode provider")}var b=null;try{b=await import("aws-xray-sdk-core")}catch{}function Q(e,t){return b&&b.captureAsyncFunc?new Promise((a,n)=>{b.captureAsyncFunc(e,async o=>{try{let r=await t();o&&o.close(),a(r)}catch(r){o&&o.addError(r),o&&o.close(),n(r)}})}):t()}async function we(e){let t=new Date().toISOString(),a=e?.requestContext?.requestId||e?.requestContext?.requestId||void 0;try{let n=e.queryStringParameters||{},o=n.lat?Number(n.lat):NaN,r=n.lng?Number(n.lng):NaN,c,i=null,s=null,u=null;if(S({requestId:a},"plan handler start",{lat:o,lng:r}),!Number.isNaN(o)&&!Number.isNaN(r)){let[d,l,m,Z]=await Promise.all([J(o,r),z(o,r),Y(o,r),B(o,r)]);c=[l.display_name,d.summary].filter(Boolean).join(" \u2014 "),i=d&&d.season||null,s=m,u=Z,S({requestId:a},"plan handler data",{reason:c,season:i,events:s,traffic:u})}let f=95;return i?.season==="summer"&&(f+=3),i?.season==="winter"&&(f-=5),u?.congestion!=null&&u.congestion>70&&(f-=10),S({requestId:a},"plan handler result",{baseScore:f}),{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Live Stop",start:t,end:t,score:f,reason:c,season:i,events:s,traffic:u,distanceKm:2.3,openNow:!0,rank:1,photo:"https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=400&q=80",hours:"8:00 AM - 8:00 PM",phone:"+1 555-123-4567",website:"https://example.com"}])}}catch(n){return V({requestId:a},"plan handler error",n),{statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Demo Stop",start:t,end:t,score:95,reason:`enrich failed: ${n.message}`}])}}}var rt=e=>Q("plan.handler",()=>we(e));export{rt as handler};
