import Z from"fs";import ee from"path";function R(e=100){let t=new Map;return{get(r){if(!t.has(r))return;let o=t.get(r);return t.delete(r),t.set(r,o),o},set(r,o){for(t.has(r)&&t.delete(r),t.set(r,o);t.size>e;)t.delete(t.keys().next().value)}}}function j(e){return[12,1,2].includes(e)?"winter":[3,4,5].includes(e)?"spring":[6,7,8].includes(e)?"summer":"autumn"}function K(e){let t=e.getUTCMonth()+1,r=e.getUTCDate(),o=t*100+r;return o>=1221||o<320?"winter":o>=320&&o<621?"spring":o>=621&&o<922?"summer":"autumn"}function b(e,t=new Date,r){let o=process&&process.env&&process.env.SEASON_MODE||r||"meteorological",n=t.getUTCMonth()+1,s=o==="astronomical"?K(t):j(n),a=e<0?"south":"north";return{season:e<0?s==="winter"?"summer":s==="summer"?"winter":s==="spring"?"autumn":"spring":s,hemisphere:a,mode:o}}import X from"sqlite3";import{open as W}from"sqlite";import O from"path";import T from"fs";var I=O.resolve(process.cwd(),"backend","external_history.sqlite");async function D(){try{let e=O.dirname(I);T.existsSync(e)||T.mkdirSync(e,{recursive:!0});try{T.openSync(I,"a").close()}catch{}let t=await W({filename:I,driver:X.Database});return await t.exec("CREATE TABLE IF NOT EXISTS history (id INTEGER PRIMARY KEY, ts TEXT, type TEXT, provider TEXT, lat REAL, lng REAL, ok INTEGER, error TEXT)"),t}catch(e){throw console.warn("initDb failed",String(e)),e}}async function w(e,t){await e.run("INSERT INTO history (ts,type,provider,lat,lng,ok,error) VALUES (?,?,?,?,?,?,?)",t.ts,t.type,t.provider,t.lat,t.lng,t.ok?1:0,t.error||null)}import{SecretsManagerClient as Y,GetSecretValueCommand as B}from"@aws-sdk/client-secrets-manager";import{SSMClient as J,GetParameterCommand as q}from"@aws-sdk/client-ssm";var z=new Y({}),Q=new J({}),g=new Map;async function h(e,t={fromSSM:!1}){if(!e)return null;if(g.has(e))return g.get(e);try{if(t.fromSSM){let s=new q({Name:e,WithDecryption:!0}),i=(await Q.send(s)).Parameter?.Value||null;return g.set(e,i),i}let r=new B({SecretId:e}),n=(await z.send(r)).SecretString||null;return g.set(e,n),n}catch(r){return console.warn("getSecretValue error",String(r)),null}}function E(e,t={},r=3e3){let o=new AbortController,n=setTimeout(()=>o.abort(),r);return fetch(e,{...t,signal:o.signal}).finally(()=>clearTimeout(n))}async function S(e,t=2,r=300){let o=null;for(let n=0;n<t;n++)try{return await e()}catch(s){o=s,await new Promise(a=>setTimeout(a,r))}throw o}var C=null;try{C=(await import("ioredis")).default}catch{}function M(){let e=process.env.REDIS_URL;if(!e||!C)return null;let t=new C(e);return{async get(r){try{let o=await t.get(r);return o?JSON.parse(o):void 0}catch{return}},async set(r,o,n=6e4){try{await t.set(r,JSON.stringify(o),"PX",n)}catch{}},async clear(){try{await t.flushdb()}catch{}}}}function v(e=6e4){try{let r=M();if(r)return{async get(o){return await r.get(o)},async set(o,n){return await r.set(o,n,e)},async clear(){return await r.clear()}}}catch{}let t=new Map;return{get(r){let o=t.get(r);if(o){if(Date.now()>o.expiry){t.delete(r);return}return o.value}},set(r,o){t.set(r,{value:o,expiry:Date.now()+e})},clear(){t.clear()}}}var N=v(3e4);async function k(e,t){let r=process.env.EVENTS_PROVIDER||"mock";if(r==="ticketmaster"){let o=`events:${e},${t}:tm`,n=await N.get(o);if(n)return n;let s=process.env.EVENTS_API_KEY,a=process.env.EVENTS_SSM_PARAMETER;a&&(s=await h(a,{fromSSM:!0})||s);let i=process.env.EVENTS_SECRET_ARN;if(!s&&i&&(s=await h(i)||s),!s)throw new Error("EVENTS_API_KEY not set");let c=`https://app.ticketmaster.com/discovery/v2/events.json?latlong=${encodeURIComponent(e)},${encodeURIComponent(t)}&radius=10&apikey=${encodeURIComponent(s)}`,u=await S(()=>E(c,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`events fetch failed: ${u.status}`);let p=((await u.json())._embedded?.events||[]).slice(0,3).map(l=>({id:l.id,name:l.name,venue:l._embedded?.venues?.[0]?.name,date:l.dates?.start?.dateTime,image:(l.images||[])[0]?.url||null,url:l.url||null,genre:l.classifications?.[0]?.genre?.name||null})),f={provider:r,events:p};return await N.set(o,f),f}return{provider:"mock",events:[{name:"Farmers Market",venue:"Main St Park",date:null},{name:"Open-Air Concert",venue:"River Stage",date:null}]}}var $=v(2e4);async function F(e,t){let r=process.env.TRAFFIC_PROVIDER||"mock";if(r==="here"){let o=`traffic:${e},${t}:here`,n=await $.get(o);if(n)return n;let s=process.env.HERE_API_KEY,a=process.env.TRAFFIC_SSM_PARAMETER;a&&(s=await h(a,{fromSSM:!0})||s);let i=process.env.TRAFFIC_SECRET_ARN;if(!s&&i&&(s=await h(i)||s),!s)throw new Error("HERE_API_KEY not set");let c=`https://traffic.ls.hereapi.com/traffic/6.2/flow.json?prox=${encodeURIComponent(e)},${encodeURIComponent(t)},5000&apiKey=${encodeURIComponent(s)}`,u=await S(()=>E(c,{method:"GET"},3e3),2,200);if(!u.ok)throw new Error(`traffic fetch failed: ${u.status}`);let d=await u.json(),p=d.RWS?.[0]?.RW?.[0]?.FIS?.[0]?.FI?.[0]?.CF?.[0]?.JF?Math.min(100,Math.round(d.RWS[0].RW[0].FIS[0].FI[0].CF[0].JF*10)):20,f={provider:r,congestion:p};return await $.set(o,f),f}return{provider:"mock",congestion:Math.round(Math.random()*40+10)}}var x=R(500),te=ee.resolve(process.cwd(),"backend","external_history.log"),m=null;try{m=D()}catch{m=null}function A(e,t={},r=3e3){let o=new AbortController,n=setTimeout(()=>o.abort(),r);return fetch(e,{...t,signal:o.signal}).finally(()=>clearTimeout(n))}async function P(e,t=2,r=300){let o=null;for(let n=0;n<t;n++)try{return await e()}catch(s){o=s,await new Promise(a=>setTimeout(a,r))}throw o}function y(e){try{Z.appendFileSync(te,JSON.stringify({ts:new Date().toISOString(),...e})+`
`)}catch{}}async function U(e,t){let r=process.env.WEATHER_PROVIDER||"open-meteo";if(r==="open-meteo"){let o=`https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(e)}&longitude=${encodeURIComponent(t)}&current_weather=true&timezone=UTC`,n=await P(()=>A(o,{method:"GET"},2500),2,300);if(!n.ok)throw new Error(`weather fetch failed: ${n.status}`);let a=(await n.json()).current_weather||{},i=a.temperature!=null?`Temp ${a.temperature}\xB0C, wind ${a.windspeed} km/h`:void 0,c=b(e,new Date);return y({type:"weather",provider:r,lat:e,lng:t,ok:!0,season:c}),{temperatureC:a.temperature,windSpeedKph:a.windspeed,weatherCode:a.weathercode,summary:i,season:c}}throw new Error("unsupported weather provider")}async function V(e,t){try{return await k(e,t)}catch(r){return{provider:"error",events:[],error:String(r)}}}async function G(e,t){try{return await F(e,t)}catch(r){return{provider:"error",congestion:null,error:String(r)}}}async function H(e,t){let r=`${e},${t}`,o=x.get(r);if(o)return o;let n=process.env.GEOCODE_PROVIDER||"nominatim";if(n==="nominatim"){let s=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(e)}&lon=${encodeURIComponent(t)}`;try{let a=await P(()=>A(s,{method:"GET",headers:{"User-Agent":"daylight/0.1 (+https://example.com)"}},2500),2,300);if(!a.ok)throw new Error(`geocode fetch failed: ${a.status}`);let c={display_name:(await a.json()).display_name};x.set(r,c);let u={type:"geocode",provider:n,lat:e,lng:t,ok:!0};return m?(await m).then(d=>w(d,{ts:new Date().toISOString(),...u})):y(u),c}catch(a){let i={type:"geocode",provider:n,lat:e,lng:t,ok:!1,error:String(a)};throw m?(await m).then(c=>w(c,{ts:new Date().toISOString(),...i})):y(i),a}}if(n==="mapbox"){let s=process.env.MAPBOX_TOKEN,a=process.env.MAPBOX_SECRET_ARN;if(a)try{let c=await h(a);c&&(s=c)}catch{}if(!s)throw new Error("MAPBOX_TOKEN not set");let i=`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(t)},${encodeURIComponent(e)}.json?access_token=${encodeURIComponent(s)}&limit=1`;try{let c=await P(()=>A(i,{method:"GET"},2500),2,300);if(!c.ok)throw new Error(`mapbox geocode failed: ${c.status}`);let p={display_name:(await c.json()).features?.[0]?.place_name};x.set(r,p);let f={type:"geocode",provider:n,lat:e,lng:t,ok:!0};return m?(await m).then(l=>w(l,{ts:new Date().toISOString(),...f})):y(f),p}catch(c){let u={type:"geocode",provider:n,lat:e,lng:t,ok:!1,error:String(c)};throw m?(await m).then(d=>w(d,{ts:new Date().toISOString(),...u})):y(u),c}}throw new Error("unsupported geocode provider")}var re=()=>(process.env.NODE_ENV||"development")==="production"?["https://daylight.app","https://www.daylight.app"]:["http://localhost:3000","http://localhost:5173","http://localhost:5174","http://127.0.0.1:3000","http://127.0.0.1:5173","http://127.0.0.1:5174"],oe=e=>e?re().includes(e):!1,ne=e=>{let t={"Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, x-api-key","Access-Control-Max-Age":"86400"};return oe(e)?{...t,"Access-Control-Allow-Origin":e}:t},_=(e,t)=>{let r=t.headers?.origin||t.headers?.Origin,o=ne(r);return{...e,headers:{...e.headers,...o}}};var Ve=async e=>{let t=new Date().toISOString();try{let r=e.queryStringParameters||{},o=r.lat?Number(r.lat):NaN,n=r.lng?Number(r.lng):NaN,s,a=null,i=null,c=null;if(!Number.isNaN(o)&&!Number.isNaN(n)){let[p,f,l,L]=await Promise.all([U(o,n),H(o,n),V(o,n),G(o,n)]);s=[f.display_name,p.summary].filter(Boolean).join(" \u2014 "),a=p&&p.season||null,i=l,c=L}let u=95;a?.season==="summer"&&(u+=3),a?.season==="winter"&&(u-=5),c?.congestion!=null&&c.congestion>70&&(u-=10);let d={statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Live Stop",start:t,end:t,score:u,reason:s,season:a,events:i,traffic:c}])};return _(d,e)}catch(r){let o={statusCode:200,headers:{"content-type":"application/json"},body:JSON.stringify([{id:"1",title:"Demo Stop",start:t,end:t,score:95,reason:`enrich failed: ${r.message}`}])};return _(o,e)}};export{Ve as handler};
